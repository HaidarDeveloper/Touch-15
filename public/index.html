<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Touch 15</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://kit.fontawesome.com/9fde29e2c1.js" crossorigin="anonymous"></script>
<style>
body { margin:0; padding:0; }
/* carousel dan loading screen styling tetap sama */
#loadingScreen { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:9999; }
.spinner { border:6px solid #ddd; border-top:6px solid #444; border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite; }
@keyframes spin { 100%{ transform:rotate(360deg); } }
</style>
</head>
<body>
<div id="loadingScreen">
  <div class="spinner"></div>
  <p class="mt-3 fs-5 text-center">Pendaftaran sedang diproses... <br/> mengarahkan ke WhatsApp.</p>
</div>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg bg-secondary-subtle px-5 fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Touch 15</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end fs-5" id="navbarNavAltMarkup">
      <div class="navbar-nav">
        <a class="nav-link active" aria-current="page" href="#beranda">Beranda</a>
        <a class="nav-link" href="#form_tiket">Pembelian Tiket</a>
      </div>
    </div>
  </div>
</nav>

<!-- HOME Carousel (sama seperti sebelumnya) -->
<section id="beranda" class="position-relative">
  <div id="carouselHome" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner">
      <div class="carousel-item active"><img src="img/touch1.jpg" class="d-block w-100" alt="Carousel 1"/></div>
      <div class="carousel-item"><img src="img/touch2.jpg" class="d-block w-100" alt="Carousel 2"/></div>
      <div class="carousel-item"><img src="img/touch3.jpg" class="d-block w-100" alt="Carousel 3"/></div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselHome" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselHome" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
  </div>

  <div class="carousel-overlay position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-start">
    <h2>Try Out Chemicalistronic - SMK SMTI YOGYAKARTA</h2>
    <div class="container text-start">
      <p class="info">TOUCH #15 ...</p>
    </div>
  </div>
</section>

<!-- FORM PEMBELIAN -->
<section id="form_tiket">
  <div class="px-5">
    <h2 class="pt-5">Pembelian Tiket</h2>
    <form class="pb-5 formtiket">
      <div id="form-pembeli"></div>
      <div class="input-group mb-3">
        <span class="input-group-text"><i class="fa-solid fa-ticket"></i></span>
        <input name="jumlah_tiket" id="idJumlahTiket" type="number" min="1" max="5" class="form-control" placeholder="Jumlah Tiket (maks 5)" required/>
      </div>
      <div class="input-group mb-3">
        <span class="input-group-text"><i class="fa-solid fa-money-check-dollar"></i></span>
        <input id="idTotalHarga" type="text" class="form-control" placeholder="Total Harga" disabled/>
      </div>
      <p>*Pembayaran akan dikirimkan melalui nomor WhatsApp peserta 1.</p>
      <div id="alertContainer"></div>
      <button type="submit" class="btn btn-outline-secondary">Kirim</button>
    <form action="/api/submit" method="POST" enctype="multipart/form-data" class="pb-5 formtiket">
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script>
const hargaTiket = 40000;
const jumlahInput = document.getElementById("idJumlahTiket");
const totalInput = document.getElementById("idTotalHarga");
const formPembeli = document.getElementById("form-pembeli");
const alertContainer = document.getElementById("alertContainer");

function hitungTotal(jumlah){
  let diskon=0;
  if(jumlah>=2) diskon=0.025;
  if(jumlah>=3) diskon=0.05;
  if(jumlah>=4) diskon=0.075;
  if(jumlah==5) diskon=0.1;
  const total=jumlah*hargaTiket*(1-diskon);
  totalInput.value="Rp "+total.toLocaleString("id-ID");
}

function buatFormPembeli(jumlah){
  formPembeli.innerHTML="";
  for(let i=1;i<=jumlah;i++){
    const formGroup=document.createElement("div");
    formGroup.classList.add("border","p-3","mb-3","rounded");
    formGroup.innerHTML=`
      <h5>Data Peserta ${i}</h5>
      <div class="input-group mb-2"><span class="input-group-text"><i class="fa-solid fa-user"></i></span><input name="nama_${i}" type="text" class="form-control" placeholder="Nama Lengkap" required/></div>
      <div class="input-group mb-2"><span class="input-group-text"><i class="fa-solid fa-school"></i></span><input name="asal_sekolah_${i}" type="text" class="form-control" placeholder="Asal Sekolah" required/></div>
      <div class="input-group mb-2"><span class="input-group-text"><i class="fa-brands fa-whatsapp"></i></span><input name="no_wa_${i}" type="number" class="form-control" placeholder="Nomor WhatsApp (628xxxx)" required/></div>
      <div class="input-group mb-2"><span class="input-group-text"><i class="fa-solid fa-envelope"></i></span><input name="email_${i}" type="email" class="form-control" placeholder="Email Peserta" required/></div>
      <div class="input-group mb-3"><span class="input-group-text"><i class="fa-solid fa-id-card"></i></span><input name="kartu_pelajar_${i}" type="file" class="form-control" accept="image/*,application/pdf" required/><label class="input-group-text">Upload Scan Kartu Pelajar</label></div>
    `;
    formPembeli.appendChild(formGroup);
  }
}

jumlahInput.addEventListener("input",()=>{
  let jumlah=parseInt(jumlahInput.value)||0;
  if(jumlah>5){jumlah=5;jumlahInput.value=5;alert("Maksimal pembelian 5 tiket!");}
  if(jumlah<1){formPembeli.innerHTML="";totalInput.value="";return;}
  buatFormPembeli(jumlah);
  hitungTotal(jumlah);
});

document.querySelector("form.formtiket").addEventListener("submit", async function(e){
  e.preventDefault();
  const loadingScreen=document.getElementById("loadingScreen");
  loadingScreen.style.display="flex";
  alertContainer.innerHTML="";

  const formData=new FormData(e.target);
  formData.append("simpan","1");

  try{
    const res=await fetch("/api/insert",{method:"POST",body:formData});
    const result=await res.json();
    if(result.status==="success"){
      const kode=result.kode_unik;
      const nomor="6285177181614";
      const pesan=`Hai, saya sudah melakukan pendaftaran ${kode}`;
      window.location.href=`https://wa.me/${nomor}?text=${encodeURIComponent(pesan)}`;
    }else{
      loadingScreen.style.display="none";
      alertContainer.innerHTML=`<div class="alert alert-danger mt-3">❌ ${result.message}</div>`;
    }
  }catch(err){
    loadingScreen.style.display="none";
    alertContainer.innerHTML=`<div class="alert alert-danger mt-3">❌ ${err.message}</div>`;
  }
});
</script>
</body>
</html>
